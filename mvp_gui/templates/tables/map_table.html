<div id="map" class="map"></div>

<!-- Include the script.js file -->
<script>
    // Simulating `jsonData` and `vehicleData` server-provided data
    const jsonData = {{ items_jsn | safe }};
    const vehicleData = {{ vehicle_jsn | safe }};

    const coordinates = document.getElementById('coordinates');
    const map = new maplibregl.Map({
        container: 'map',
        zoom: 12,
        center: [vehicleData.lon, vehicleData.lat], //long lat
        style:
            'https://api.maptiler.com/maps/hybrid/style.json?key=XiFHd4BzZGlB2Dsix5mK'
    });


    map.addControl(new maplibregl.NavigationControl());
    map.addControl(new maplibregl.ScaleControl({
        maxWidth: 80,
        unit: 'metric' // 'metric' or 'nautical'
    }));

    // Prepare GeoJSON data for the route
    let coordinatesData = jsonData.map(entry => ({
        latitude: entry.lat,
        longitude: entry.lon
    }));
    const geojson = {
        type: 'FeatureCollection',
        features: [
            {
                type: 'Feature',
                geometry: {
                    type: 'LineString',
                    coordinates: coordinatesData.map(coord => [coord.longitude, coord.latitude])
                }
            }
        ]
    };

    // Initialize the map and add the route
    map.on('load', () => {
        map.addSource('route', {
            type: 'geojson',
            data: geojson
        });

        map.addLayer({
            id: 'route',
            type: 'line',
            source: 'route',
            layout: {
                'line-join': 'round',
                'line-cap': 'round'
            },
            paint: {
                'line-color': '#F7455D',
                'line-width': 4
            }
        });

        // Add the AUV marker (non-draggable)
        const markerAUV = new maplibregl.Marker({ draggable: false })
            .setLngLat([vehicleData.lon, vehicleData.lat])
            .addTo(map);

        // Function to handle marker drag end
        function onDragEnd(marker, item, index) {
            return function() {
                const coordinates = marker.getLngLat();
                fetch('/waypoint_drag', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        id: item.id,
                        lng: coordinates.lng,
                        lat: coordinates.lat
                    })
                });

                // Update GeoJSON data for the line
                coordinatesData[index] = { longitude: coordinates.lng, latitude: coordinates.lat };
                map.getSource('route').setData({
                    type: 'FeatureCollection',
                    features: [
                        {
                            type: 'Feature',
                            geometry: {
                                type: 'LineString',
                                coordinates: coordinatesData.map(coord => [coord.longitude, coord.latitude])
                            }
                        }
                    ]
                });
            };
        }

        // Function to create a marker with drag functionality
        function createMarker(item, color, index) {
            const marker = new maplibregl.Marker({ draggable: true, color: color })
                .setLngLat([item.lon, item.lat])
                .addTo(map);

            marker.on('dragend', onDragEnd(marker, item, index));
        }

        // Create markers and ensure the route is updated on drag
        jsonData.forEach((item, index) => {
            let color = item.id === 1 ? "#e50112" : "#808080";
            if (index === jsonData.length - 1) {
                color = "#00FF00";
            }
            createMarker(item, color, index);
        });
    });

</script>
