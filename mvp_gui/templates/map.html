<!DOCTYPE html>
<html lang="en">
<head>
    <title>Display a satellite map</title>
    <meta property="og:description" content="Display a satellite raster baselayer." />
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel='stylesheet' href='https://unpkg.com/maplibre-gl@4.2.0/dist/maplibre-gl.css' />
    <script src='https://unpkg.com/maplibre-gl@4.2.0/dist/maplibre-gl.js'></script>
    <script src="https://api.maptiler.com/maps/hybrid/style.json?key=get_your_own_OpIi9ZULNHzrESv6T2vL"></script>
    <style>
        #map { margin-left: 0%; margin-right:0%; padding: 0; }
        html, body, #map { height: 100%}
    </style>

    {{ turbo() }}
</head>
<body>
    <div id="map"></div>
    <script>
        
        const jsonData = {{ items_jsn | safe }};
        const coordinates = document.getElementById('coordinates');
        const map = new maplibregl.Map({
            container: 'map',
            zoom: 9,
            center: [-71.421376, 41.491393], //long lat
            style:
                'https://api.maptiler.com/maps/hybrid/style.json?key=get_your_own_OpIi9ZULNHzrESv6T2vL'
        });
        map.addControl(new maplibregl.NavigationControl()); 
        
        map.on('load', () =>{
            //make lines
            const coordinates = jsonData.map(entry => ({
                latitude: entry.lat,
                longitude: entry.lon
            }));
            const geojson = {
                type: 'FeatureCollection',
                features: [
                    {
                        type: 'Feature',
                        geometry: {
                            type: 'LineString',
                            coordinates: coordinates.map(coord => [coord.longitude, coord.latitude])
                        },
                        properties: {
                            // You can add additional properties here if needed
                        }
                    }
                ]
            };
            map.addSource('route', {
                type: 'geojson',
                data: geojson
            });

            map.addLayer({
                id: 'route',
                type: 'line',
                source: 'route',
                layout: {
                    'line-join': 'round',
                    'line-cap': 'round'
                },
                paint: {
                    'line-color': '#F7455D',
                    'line-width': 4
                }
            });
                    
            ///add marker
            jsonData.forEach(item => {
                const marker = new maplibregl.Marker({draggable: true})
                .setLngLat([item.lon, item.lat])
                .addTo(map);
                function onDragEnd() {
                    const coordinates = marker.getLngLat();
                    fetch('/waypoint_drag', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        id: item.id,
                        lng: coordinates.lng,
                        lat: coordinates.lat
                    })
                });
                }
                marker.on('dragend', onDragEnd);
                
            });
        });
    </script>
</body>
    Current longitude

</html>